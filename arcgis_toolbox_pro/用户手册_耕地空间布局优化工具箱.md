# 耕地空间布局优化工具箱 (DRL) — 用户手册

## 1. 工具概述

本工具箱基于**深度强化学习（Deep Reinforcement Learning, DRL）**技术，实现耕地空间布局优化。核心算法采用 **Maskable PPO**（带掩码的近端策略优化），通过配对的耕地-林地用地类型互换，在**保持耕地总量不变**的前提下：

- **降低耕地平均坡度** — 将高坡度耕地置换为林地
- **提升空间连片性** — 使耕地在空间上更加集中连片

工具箱以 ArcGIS Pro Python Toolbox（.pyt）形式提供，可直接在 ArcGIS Pro 中加载使用。

---

## 2. 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Windows 10/11（64位） |
| GIS 软件 | ArcGIS Pro 3.x 及以上 |
| Python | ArcGIS Pro 内置 Python 3.9+（自动附带） |
| PyTorch | CPU 版本（需手动安装，见下方说明） |
| 许可级别 | Standard 或 Advanced（推荐 Advanced） |
| 磁盘空间 | 工具箱约 500 KB |

> **关于许可级别**：Advanced 许可可使用 `PolygonNeighbors` 工具快速构建邻接图；Standard 许可会自动回退到几何相交方法，速度较慢但结果一致。

---

## 3. 安装部署

### 3.1 复制工具箱文件

将整个 `arcgis_toolbox` 文件夹复制到目标机器，保持以下目录结构不变：

```
arcgis_toolbox/
├── LandUseOptimization.pyt              ← 主工具箱文件
├── LandUseOptimization.pyt.xml          ← 工具箱元数据
├── LandUseOptimization.CheckDependenciesTool.pyt.xml
├── LandUseOptimization.OptimizeLandUseTool.pyt.xml
├── core/                                ← 核心计算模块
│   ├── __init__.py
│   ├── scorer_standalone.py             ← DRL 评分网络
│   ├── data_io.py                       ← 数据读写
│   ├── adjacency.py                     ← 空间邻接图构建
│   └── paired_inference.py              ← 配对推理引擎
└── models/
    └── scorer_weights_v7.pt             ← 训练好的模型权重
```

> **注意**：`core/` 文件夹和 `models/` 文件夹必须与 `.pyt` 文件位于同一目录下，不要改变相对路径关系。

### 3.2 安装 PyTorch

打开 **ArcGIS Pro 的 Python 命令提示符**（非系统 CMD），执行：

```
pip install torch --index-url https://download.pytorch.org/whl/cpu
```

**操作步骤**：
1. 打开 ArcGIS Pro
2. 点击菜单栏 → **Project（工程）** → **Python**
3. 点击 **Manage Environments（管理环境）**，如果需要可先克隆默认环境
4. 关闭 ArcGIS Pro
5. 在 Windows 开始菜单中找到 **Python Command Prompt**（ArcGIS Pro 专用）
6. 执行上述 `pip install` 命令
7. 等待安装完成后重新打开 ArcGIS Pro

> **提示**：如果默认环境不允许安装包，请先克隆一个新环境再安装。克隆路径：ArcGIS Pro → Project → Python → Manage Environments → Clone Default。

### 3.3 在 ArcGIS Pro 中加载工具箱

1. 打开 ArcGIS Pro，打开一个工程
2. 在 **Catalog（目录）** 面板中，右键点击 **Toolboxes（工具箱）**
3. 选择 **Add Toolbox（添加工具箱）**
4. 浏览到 `LandUseOptimization.pyt` 文件，点击 **OK**
5. 工具箱将出现在 Toolboxes 列表中，展开可看到两个工具

---

## 4. 工具详细说明

### 4.1 依赖检查 (Check Dependencies)

**用途**：在首次使用前验证运行环境是否满足要求。

**操作方式**：直接双击运行，无需任何参数。

**检查项目**：

| 检查项 | 说明 |
|--------|------|
| Python 版本 | 显示当前 Python 版本号 |
| PyTorch | 检查是否已安装及版本号 |
| NumPy | 检查是否已安装及版本号 |
| arcpy | 检查版本和许可级别 |
| PolygonNeighbors | 检查 Advanced 许可是否可用 |
| 模型权重 | 检查默认权重文件是否存在 |

**结果解读**：
- 所有项目显示 "OK" → 环境就绪，可以使用优化工具
- 出现红色 Error → 必须解决后才能运行优化（如 PyTorch 未安装）
- 出现黄色 Warning → 可运行但可能有限制（如无 Advanced 许可）

---

### 4.2 DRL 用地优化 (DRL Land Use Optimization)

**用途**：执行基于 DRL 模型的耕地空间布局优化。

#### 4.2.1 参数说明

**必需参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| 输入要素类 | 面要素类 | 包含用地地块的面数据。必须包含用地分类文本字段和坡度数值字段。支持 Shapefile 和文件地理数据库要素类。 |
| 用地分类字段 (DLMC) | 文本字段 | 用地分类名称字段，值如"旱地""水田""果园""有林地"等。工具通过该字段区分耕地和林地。 |
| 坡度字段 | 数值字段 | 坡度值字段（单位：度），优化目标为降低耕地平均坡度。通常为基于 DEM 的区域统计结果。 |
| 输出要素类 | 面要素类 | 优化结果的输出路径。 |

**可选参数：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| 模型权重文件 | .pt 文件 | models/scorer_weights_v7.pt | 训练好的 DRL 模型权重，模型维度无关，可跨数据集使用 |
| 转换对数 | 整数 (1-500) | 100 | 执行的耕地-林地互换对数，越大优化越充分 |
| 耕地类型名称 | 文本列表 | 旱地, 水田 | 耕地分类名称，须与数据中的值完全匹配 |
| 林地类型名称 | 文本列表 | 果园, 有林地 | 林地分类名称，须与数据中的值完全匹配 |

#### 4.2.2 输出字段说明

优化完成后，输出要素类在保留所有原始字段的基础上，新增以下4个字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| OPT_DLMC | Text(30) | 优化后的用地分类名称 |
| OPT_TYPE | Short | 优化后类型编码：0=其他, 1=耕地, 2=林地 |
| CHG_FLAG | Short | 变化标记：0=未变化, 1=耕地→林地, 2=林地→耕地 |
| ORIG_DLMC | Text(30) | 原始用地分类名称（便于对比） |

> **提示**：使用 `CHG_FLAG` 字段可快速筛选和可视化发生变化的地块。例如，按 CHG_FLAG 分类渲染：0=灰色, 1=绿色（新增林地）, 2=黄色（新增耕地）。

#### 4.2.3 处理流程

工具执行时经历以下5个阶段，每个阶段的进度信息会实时显示在进度条和消息面板中：

```
阶段 1：加载模型    → 读取 .pt 权重文件，构建评分网络
阶段 2：读取数据    → 读取要素类，分类地块（耕地/林地/其他）
阶段 3：构建邻接图  → 计算地块间的空间邻接关系
阶段 4：配对推理    → 交替执行 耕地→林地 和 林地→耕地 互换
阶段 5：写入输出    → 生成包含优化结果的新要素类
```

---

## 5. 使用示例

### 5.1 图形界面操作

1. 展开工具箱，双击 **DRL Land Use Optimization**
2. 设置参数：
   - **输入要素类**：浏览选择待优化的面数据（如 `斑竹村10000.shp`）
   - **用地分类字段**：从下拉列表中选择 `DLMC`
   - **坡度字段**：从下拉列表中选择 `Slope`
   - **输出要素类**：指定输出路径（如 `D:\results\optimized.shp`）
   - 其他参数保持默认即可
3. 点击 **Run（运行）**
4. 在消息面板中查看执行进度和优化结果摘要

### 5.2 Python 脚本调用

```python
import arcpy

# 加载工具箱
arcpy.ImportToolbox(r"D:\arcgis_toolbox\LandUseOptimization.pyt")

# 运行优化
arcpy.LandUseOpt.OptimizeLandUseTool(
    input_fc=r"D:\data\study_area.shp",
    dlmc_field="DLMC",
    slope_field="Slope",
    output_fc=r"D:\results\optimized.shp",
    model_weights=r"D:\arcgis_toolbox\models\scorer_weights_v7.pt",
    n_pairs=100,
    farmland_types=["旱地", "水田"],
    forest_types=["果园", "有林地"],
)
```

### 5.3 查看优化结果

运行完成后，消息面板会显示优化摘要，例如：

```
=== Optimization Results ===
  Completed pairs: 100
  Slope: 12.3456 -> 11.9234 (change: -0.4222, -3.42%)
  Contiguity: 2.1500 -> 2.2037 (change: +0.0537)
  Farmland count change: 0
```

- **Slope**：耕地平均坡度变化（负值表示降低，期望为负）
- **Contiguity**：空间连片性变化（正值表示提升，期望为正）
- **Farmland count change**：耕地数量变化（应为 0，即耕地总量守恒）

---

## 6. 数据准备要求

### 6.1 输入数据格式

- **几何类型**：面（Polygon）
- **坐标系**：推荐使用投影坐标系（单位为米），如 CGCS2000 高斯-克吕格投影
- **文件格式**：Shapefile (.shp) 或文件地理数据库要素类 (.gdb)

### 6.2 必需字段

| 字段 | 要求 |
|------|------|
| 用地分类字段 | 文本类型，包含用地分类名称（如 DLMC） |
| 坡度字段 | 数值类型（Double/Single/Long/Short），包含坡度值 |

### 6.3 用地分类值

工具通过精确匹配用地分类字段的文本值来区分耕地和林地。请确保：

- 数据中的分类名称与工具参数中设置的类型名称**完全一致**（区分大小写）
- 不参与优化的地块类型无需特别设置（自动归类为"其他"）
- 如果数据使用不同于默认值的分类名称，请在参数中相应修改

**默认分类名称：**
- 耕地：`旱地`、`水田`
- 林地：`果园`、`有林地`

---

## 7. 常见问题 (FAQ)

### Q1: PyTorch 安装失败怎么办？

**A**：确保使用 ArcGIS Pro 专用的 Python Command Prompt（而非系统 CMD）。如果默认环境被锁定，需先克隆环境：

1. ArcGIS Pro → Project → Python → Manage Environments → Clone Default
2. 激活克隆的新环境
3. 关闭 ArcGIS Pro
4. 重新打开 Python Command Prompt，执行安装命令

### Q2: 运行时提示 "No farmland parcels found"？

**A**：用地分类字段中没有找到与"耕地类型名称"匹配的值。请检查：
- 用地分类字段是否选择正确
- 耕地类型名称是否与数据中的值完全一致（包括空格、全角/半角字符等）

### Q3: 运行速度很慢（邻接图构建阶段）？

**A**：可能原因是 ArcGIS Pro 许可级别非 Advanced，使用了几何相交回退方法。解决方案：
- 升级到 Advanced 许可（推荐）
- 耐心等待（结果与 Advanced 许可一致，仅速度差异）
- 减少输入数据量

### Q4: 可以用于其他区域的数据吗？

**A**：可以。模型是维度无关的，同一权重文件可用于任意数量地块的数据集，无需重新训练。但请确保：
- 数据包含所需的用地分类和坡度字段
- 根据实际数据调整耕地/林地类型名称参数

### Q5: 如何调整优化程度？

**A**：通过"转换对数"参数控制。
- **较小值（如 30-50）**：快速运行，优化幅度较小
- **默认值（100）**：平衡的优化效果
- **较大值（如 200-500）**：更充分的优化，但耗时更长
- 实际值不会超过耕地和林地数量中的较小值

### Q6: 优化后耕地数量不为0怎么办？

**A**：在配对推理模式下，耕地数量变化（FC）应始终为 0。如果不为 0，请检查：
- 是否有地块同时属于耕地和林地类型（类型名称设置冲突）
- 联系开发者排查问题

### Q7: 如何可视化优化结果？

**A**：推荐按 `CHG_FLAG` 字段进行分类符号化渲染：
- `CHG_FLAG = 0`：未变化地块（灰色/透明）
- `CHG_FLAG = 1`：耕地→林地（绿色）
- `CHG_FLAG = 2`：林地→耕地（黄色/橙色）

也可以对比 `ORIG_DLMC` 和 `OPT_DLMC` 字段查看具体的分类变化。

---

## 8. 技术原理简介

### 8.1 算法框架

本工具采用 **Maskable PPO**（带动作掩码的近端策略优化）算法，训练了一个**评分网络（Scorer Network）**。该网络对每个地块评分，通过动作掩码机制选择最优的互换对象。

### 8.2 配对推理策略

每一轮操作包含两步：
1. **Phase 0**：从所有耕地中选择一个最优地块，将其转为林地
2. **Phase 1**：从所有林地中选择一个最优地块，将其转为耕地

每完成一对操作，耕地总量保持不变，实现 **FC=0**（耕地数量守恒）。

详细的算法设计与特征工程请参见相关学术论文。

---

## 9. ArcMap 版本说明

本工具箱提供了 **ArcMap 10.x 兼容版本**（位于 `arcgis_toolbox_arcmap/` 文件夹），适用于仍在使用 ArcMap 的用户。

### 9.1 ArcMap 版本与 ArcGIS Pro 版本的区别

| 项目 | ArcGIS Pro 版本 | ArcMap 版本 |
|------|----------------|-------------|
| 目录 | `arcgis_toolbox/` | `arcgis_toolbox_arcmap/` |
| Python | 3.9+（64 位） | 2.7（32 位） |
| 推理引擎 | PyTorch | 纯 NumPy（无需 PyTorch） |
| 权重格式 | `.pt`（PyTorch） | `.npz`（NumPy） |
| 依赖 | 需安装 PyTorch | 无额外依赖（NumPy 已内置） |
| 内存限制 | 无明显限制 | 32 位约 2 GB，大数据集需注意 |
| 优化结果 | 完全一致 | 完全一致 |

> **两个版本的优化结果完全一致**——NumPy 版本经过严格验证，与 PyTorch 版本的输出误差小于 1e-5。

### 9.2 ArcMap 版本部署

1. 将 `arcgis_toolbox_arcmap/` 文件夹复制到目标机器
2. **无需安装任何额外包**（NumPy 随 ArcMap 自带）
3. 在 ArcMap 中右键 ArcToolbox → Add Toolbox → 浏览到 `LandUseOptimization.pyt`

### 9.3 权重转换

ArcMap 版本使用 `.npz` 格式的模型权重（已随工具箱提供）。如需更新权重：

1. 在 Python 3 + PyTorch 环境（如 ArcGIS Pro 的 Python）下运行转换脚本：
   ```
   python convert_weights_to_npz.py
   ```
2. 将生成的 `.npz` 文件复制到 `arcgis_toolbox_arcmap/models/` 目录

### 9.4 ArcMap 注意事项

- **32 位内存限制**：ArcMap 使用 32 位 Python，处理超过 50,000 条记录时可能内存不足。如遇此问题，建议使用 ArcGIS Pro 版本
- **处理速度**：由于 32 位和 Python 2.7 的限制，运行速度可能略慢于 Pro 版本
- **功能完全一致**：参数、输出字段、优化算法与 Pro 版本完全相同

---

## 10. 联系与支持

如在使用中遇到问题，请准备以下信息以便排查：
- ArcGIS 软件版本号（Pro / ArcMap）和许可级别
- 依赖检查工具的输出截图
- 输入数据的基本信息（记录数、字段名、坐标系）
- 运行时的错误消息完整截图
